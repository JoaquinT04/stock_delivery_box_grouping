<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_delivery_document_box_grouping" inherit_id="stock.report_delivery_document" priority="99">
        
        <!-- Ocultar tabla standard -->
        <xpath expr="//table[@name='stock_move_table']" position="attributes">
            <attribute name="t-if">False</attribute>
        </xpath>

        <!-- Reemplazo principal -->
        <xpath expr="//table[@name='stock_move_line_table']" position="replace">
            
            <!-- === CAPTURA DE COLORES NATIVOS === -->
            <t t-set="p_color" t-value="o.company_id.primary_color or '#000000'"/>
            <t t-set="s_color" t-value="o.company_id.secondary_color or '#000000'"/>

            <!-- === PREPARACIÓN DE DATOS === -->
            <t t-set="all_lines" t-value="o.move_line_ids"/>
            <t t-set="lines_with_box" t-value="[]"/>
            <t t-foreach="all_lines" t-as="l">
                <t t-set="eff_box" t-value="str(l.x_studio_caja or l.move_id.x_studio_caja or '')"/>
                <t t-if="eff_box">
                    <t t-set="lines_with_box" t-value="lines_with_box + [{'line': l, 'box': eff_box}]"/>
                </t>
            </t>
            <t t-set="unique_boxes" t-value="list(set(item['box'] for item in lines_with_box))"/>
            <t t-set="unique_boxes" t-value="sorted(unique_boxes, key=lambda x: int(x) if x.isdigit() else x)"/>

            <!-- ============================================== -->
            <!-- 1. BLOQUE AGRUPADO POR CAJAS                 -->
            <!-- ============================================== -->
            <t t-foreach="unique_boxes" t-as="box">
                
                <t t-set="current_box_items" t-value="[item for item in lines_with_box if item['box'] == box]"/>
                <t t-set="box_total_qty" t-value="sum((item['line'].qty_done if o.state == 'done' else item['line'].quantity) for item in current_box_items)"/>

                <div class="mt-4 mb-3" style="page-break-inside: avoid;">
                    
                    <!-- ESTILO NATIVO DE SECCIÓN (Como en Presupuestos/Facturas) -->
                    <!-- Título en Color Primario + Línea inferior del mismo color -->
                    <div class="row mb-2">
                        <div class="col-12">
                            <h4 t-attf-style="color: {{p_color}}; padding-bottom: 5px; margin-bottom: 5px;">
                                <span class="fa fa-box-open mr-2"/> Caja <t t-esc="box"/>
                            </h4>
                        </div>
                    </div>

                    <!-- TABLA NATIVA (o_main_table hereda striped/bold de la config) -->
                    <table class="table table-sm o_main_table" name="stock_move_line_table_box">
                        <thead>
                            <tr>
                                <th class="text-start"><strong>Producto</strong></th>
                                <th class="text-end"><strong>Cantidad</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="current_box_items" t-as="item">
                                <t t-set="move_line" t-value="item['line']"/>
                                <tr>
                                    <td>
                                        <span t-field="move_line.product_id.display_name"/>
                                        <p t-if="move_line.description_picking != move_line.product_id.name and move_line.description_picking" class="text-muted small">
                                            <span t-field="move_line.description_picking"/>
                                        </p>
                                    </td>
                                    <td class="text-end">
                                        <t t-if="o.state == 'done'">
                                            <span t-field="move_line.qty_done"/>
                                        </t>
                                        <t t-else="">
                                            <span t-field="move_line.quantity"/>
                                        </t>
                                        <span t-field="move_line.product_uom_id"/>
                                    </td>
                                </tr>
                            </t>
                            
                            <!-- SUBTOTAL POR CAJA (Sutil) -->
                            <tr class="is-subtotal text-end">
                                <td t-attf-style="border-top: 1px solid {{s_color}};">
                                    <strong class="mr16">Total Caja <t t-esc="box"/></strong>
                                </td>
                                <td t-attf-style="border-top: 1px solid {{s_color}};">
                                    <span t-esc="box_total_qty" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}" class="font-weight-bold"/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </t>

            <!-- ============================================== -->
            <!-- 2. BLOQUE SUELTOS (Sin Caja)                 -->
            <!-- ============================================== -->
            <t t-set="lines_no_box" t-value="all_lines.filtered(lambda l: not l.x_studio_caja and not l.move_id.x_studio_caja)"/>
            
            <t t-if="lines_no_box and any(l.quantity &gt; 0 for l in lines_no_box)">
                <div class="mt-4 mb-3" style="page-break-inside: avoid;">
                    
                    <div class="row mb-2">
                        <div class="col-12">
                            <!-- Usamos un color naranja standard para diferenciar lo no agrupado, pero estilo limpio -->
                            <h5 style="color: #e67e22; border-bottom: 1px solid #e67e22; padding-bottom: 5px;">
                                <span class="fa fa-exclamation-triangle mr-2"/> Sin Agrupar
                            </h5>
                        </div>
                    </div>

                    <table class="table table-sm o_main_table">
                        <thead>
                            <tr>
                                <th class="text-start"><strong>Producto</strong></th>
                                <th class="text-end"><strong>Cantidad</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="lines_no_box" t-as="move_line">
                                <td>
                                    <span t-field="move_line.product_id.display_name"/>
                                </td>
                                <td class="text-end">
                                    <t t-if="o.state == 'done'">
                                        <span t-field="move_line.qty_done"/>
                                    </t>
                                    <t t-else="">
                                        <span t-field="move_line.quantity"/>
                                    </t>
                                    <span t-field="move_line.product_uom_id"/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </t>

            <!-- ============================================== -->
            <!-- 3. TOTAL GENERAL (Estilo Factura)             -->
            <!-- ============================================== -->
            <t t-set="grand_total_qty" t-value="sum((l.qty_done if o.state == 'done' else l.quantity) for l in all_lines)"/>

            <div class="clearfix" name="so_total_summary">
                <div id="total" class="row" name="total">
                    <div t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-7 col-md-6'} ms-auto">
                        <table class="table table-sm table-borderless">
                            <!-- Línea superior gruesa en color primario, igual que facturas -->
                            <tr class="border-black o_total" t-attf-style="border-top: 2px solid;">
                                <td><strong>Total General</strong></td>
                                <td class="text-end">
                                    <!-- Texto en color primario para destacar -->
                                    <strong t-attf-style="font-size: 1.2em;">
                                        <span t-esc="grand_total_qty" t-options="{&quot;widget&quot;: &quot;float&quot;, &quot;precision&quot;: 2}"/>
                                    </strong>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

        </xpath>
    </template>
</odoo>