<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- 1. ACCIÓN DE REPORTE -->
    <record id="report_product_vehicle_label" model="ir.actions.report">
        <field name="name">Etiqueta Vehículo</field>
        <field name="model">product.product</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">stock_delivery_box_grouping_module.report_product_label_vehicle_template</field>
        <field name="report_file">stock_delivery_box_grouping_module.report_product_label_vehicle_template</field>
        <field name="paperformat_id" ref="stock_delivery_box_grouping_module.paperformat_product_label_vehicle"/>
    </record>

    <!-- 2. PLANTILLA DE DISEÑO OPTIMIZADA -->
    <template id="report_product_label_vehicle_template">
        <t t-call="web.html_container">
            <div class="page">
                <t t-foreach="quantity_by_product" t-as="p">
                    <t t-set="qty" t-value="quantity_by_product[p]"/>
                    <t t-set="product" t-value="request.env['product.product'].sudo().browse(int(p))"/>
                    
                    <t t-foreach="range(qty)" t-as="i">
                        
                        <!-- 
                           CONTENEDOR MAESTRO (Etiqueta individual):
                           - width: 100mm (Ancho del papel)
                           - height: 48mm (2mm menos que el papel para evitar salto de hoja por margen invisible)
                           - Page-break-inside: avoid (Esta es la clave para no usar 'always').
                           - overflow: hidden (Si algo es gigante, lo corta en vez de crear otra hoja)
                        -->
                        <div style="width: 90mm; height: 45mm; page-break-inside: avoid; padding: 0; margin: 0; overflow: hidden; position: relative; background-color: white;">
                            
                            <!-- MARGEN INTERNO SEGURO (2mm) -->
                            <div style="padding: 2mm; margin-right: 10mm; width: 100%; height: 100%; box-sizing: border-box;">
                                
                                <table style="width: 100%; height: 100%; border-collapse: collapse;">
                                    
                                    <!-- FILA 1: CABECERA (10mm Alto) -->
                                    <tr style="height: 10mm;">
                                        <!-- CAPEMI -->
                                        <td style="width: 40%; vertical-align: middle;">
                                            <span style="font-family: Arial, sans-serif; font-size: 16px; font-weight: 900; color: #000;">CAPEMI</span>
                                        </td>
                                        <!-- IND ARG -->
                                        <td style="width: 20%; vertical-align: middle; text-align: center;">
                                            <span style="font-family: Arial, sans-serif; font-size: 7px; font-weight: bold; color: #444;">IND ARG</span>
                                        </td>
                                        <!-- LOGO VEHÍCULO -->
                                        <td style="width: 40%; vertical-align: middle; text-align: right; ">
                                            <t t-if="product.vehicle_brand_id.logo">
                                                <!-- Forzamos altura máxima para que no se corte ni empuje -->
                                                <img t-att-src="image_data_uri(product.vehicle_brand_id.logo)" style="max-height: 9mm; max-width: 35mm; width: auto; object-fit: contain;"/>
                                            </t>
                                        </td>
                                    </tr>

                                    <!-- FILA 2: DATOS PRINCIPALES (19mm Alto) -->
                                    <tr style="height: 10mm;">
                                        <td colspan="3" style="vertical-align: top; padding-top: 1mm;">
                                            <!-- Referencia (Código) -->
                                            <div style="font-family: Arial, sans-serif; font-size: 26px; font-weight: 900; line-height: 1; color: #000;">
                                                <span t-field="product.default_code"/>
                                            </div>
                                            
                                            <!-- Nombre Producto -->
                                            <div style="font-family: Arial, sans-serif; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-top: 2px; line-height: 1.1; max-height: 8mm; overflow: hidden;">
                                                <span t-field="product.name"/>
                                            </div>

                                            <!-- Modelo Vehículo -->
                                            <div style="font-family: Arial, sans-serif; font-size: 10px; margin-top: 2px; font-weight: bold; font-style: italic;">
                                                <span t-field="product.vehicle_model_text"/>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- FILA 3: PIE (BARCODE) (Resto - aprox 12mm) -->
                                    <tr>
                                        <td colspan="3" style="vertical-align: bottom; text-align: center;">
                                            <t t-if="product.barcode">
                                                <!-- 
                                                    BARCODE CORREGIDO (Estilo Odoo Nativo):
                                                    - t-out: Imprime el HTML generado por el widget.
                                                    - quiet: 0 (Quita márgenes blancos laterales).
                                                    - img_style: Define el tamaño CSS real (ancho casi total, altura controlada).
                                                    - humanreadable: 1 (Muestra el número abajo integrado).
                                                -->
                                                <div t-out="product.barcode" t-options="{'widget': 'barcode', 'symbology': 'auto', 'img_style': 'width:40mm; height:12mm;', 'quiet': 0, 'humanreadable': 1}"/>
                                            </t>
                                        </td>
                                    </tr>

                                </table>
                            </div>
                        </div>
                    </t>
                </t>
            </div>
        </t>
    </template>
</odoo>